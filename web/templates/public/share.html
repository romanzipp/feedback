{{define "share"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Share.Name}}</title>
    <link rel="stylesheet" href="/static/css/output.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
<div class="max-w-6xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{.Share.Name}}</h1>
        {{if .Share.Description}}
        <p class="text-gray-600">{{.Share.Description}}</p>
        {{end}}
    </div>

    {{if not .Username}}
    <div class="mb-8 bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Enter Your Name</h2>
        <form method="POST" action="/share/{{.Hash}}/name" class="flex gap-4">
            <input type="text" name="username" required placeholder="Your name"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
            <button type="submit" class="bg-primary text-white px-6 py-2 rounded hover:bg-blue-600">
                Continue
            </button>
        </form>
    </div>
    {{else}}
    <p class="mb-8 text-gray-600">Logged in as: <strong>{{.Username}}</strong></p>
    {{end}}

    {{if .Files}}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {{range .Files}}
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden flex flex-col">
            {{if and (ne .File.MimeType "") (hasPrefix .File.MimeType "image/")}}
            <img src="/files/{{.File.ID}}" alt="{{.File.Filename}}" class="w-full cursor-pointer hover:opacity-90" data-file-id="{{.File.ID}}" onclick="openModal({{.File.ID}})" style="max-height: 300px; object-fit: contain; background: #f9fafb;">
            {{else}}
            <div class="p-4 bg-gray-100">
                <a href="/files/{{.File.ID}}" target="_blank" class="text-primary hover:underline font-medium">{{.File.Filename}}</a>
            </div>
            {{end}}

            <div class="p-3 flex-1 flex flex-col">
                <p class="text-xs text-gray-600 mb-2 truncate">{{.File.Filename}}</p>

                <div class="border-t pt-2 flex-1 flex flex-col">
                    <p class="text-xs font-semibold text-gray-700 mb-2">Comments ({{len .Comments}})</p>
                    <div id="comments-{{.File.ID}}" class="space-y-2 mb-2 overflow-y-auto max-h-32">
                        {{range .Comments}}
                        <div class="bg-gray-50 rounded p-2">
                            <div class="flex items-baseline gap-1 mb-1">
                                <span class="text-xs font-medium text-gray-900">{{.Username}}</span>
                                <span class="text-xs text-gray-400 relative-time" data-time="{{.CreatedAt.Format "2006-01-02T15:04:05Z07:00"}}">{{.CreatedAt.Format "01/02 15:04"}}</span>
                            </div>
                            <p class="text-xs text-gray-700">{{.Content}}</p>
                        </div>
                        {{end}}
                    </div>

                    {{if $.Username}}
                    <form class="comment-form mt-auto" data-file-id="{{.File.ID}}">
                        <textarea name="content" required placeholder="Add comment..." rows="2"
                                  class="w-full text-xs px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary mb-1"></textarea>
                        <button type="submit" class="w-full bg-primary text-white text-xs px-2 py-1 rounded hover:bg-blue-600">
                            Post
                        </button>
                    </form>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <p class="text-gray-500">No files available yet.</p>
    {{end}}
</div>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50" onclick="closeModal()">
    <div class="max-w-7xl max-h-full p-4">
        <img id="modal-img" src="" alt="" class="max-w-full max-h-screen object-contain">
    </div>
</div>
    </div>
    <script src="/static/js/modal.js" type="module"></script>
    <script src="/static/js/comments.js" type="module"></script>
    <script>
    // Update relative times
    function updateRelativeTimes() {
        document.querySelectorAll('.relative-time').forEach(el => {
            const time = new Date(el.dataset.time);
            el.textContent = getRelativeTime(time);
        });
    }

    function getRelativeTime(date) {
        const seconds = Math.floor((new Date() - date) / 1000);

        if (seconds < 60) return 'just now';
        if (seconds < 3600) {
            const mins = Math.floor(seconds / 60);
            return mins + 'm ago';
        }
        if (seconds < 86400) {
            const hours = Math.floor(seconds / 3600);
            return hours + 'h ago';
        }
        if (seconds < 2592000) {
            const days = Math.floor(seconds / 86400);
            return days + 'd ago';
        }

        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return month + '/' + day;
    }

    // Initial update
    updateRelativeTimes();

    // Update every minute
    setInterval(updateRelativeTimes, 60000);
    </script>
</body>
</html>
{{end}}
